<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجر مستحضرات التجميل</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCa-xvfswQlKiDRGlhI1Tbs1KfbK5JJPKg&libraries=places&callback=initMap" async defer></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f2f7;
        }

        .product-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-section {
            display: none;
        }

        .user-section {
            display: none;
        }

        .login-section,
        .register-section,
        .admin-login-section {
            display: flex;
        }

        .notification-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            transition: opacity 0.5s ease-in-out;
        }

        .notification-bar.show {
            display: block;
            opacity: 1;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            20% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        .notification-bar.animate {
            animation: fadeInOut 3s forwards;
        }

        /* Modal styling */
        .modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 1.75rem;
            cursor: pointer;
            color: #888;
        }

        /* Invoice styling for printing */
        .invoice-print-container {
            font-family: 'Cairo', sans-serif;
        }

        /* خريطة التوصيل */
        .delivery-map {
            height: 300px;
            width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .address-form {
            background-color: #f9f9f9;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* قسم التوصيل في لوحة المسؤول */
        .delivery-orders {
            margin-top: 2rem;
        }

        .delivery-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #ec4899;
        }

        .delivery-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-delivered {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-processing {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* تحسين للجداول في الموبايل */
        table {
            overflow-x: auto;
            display: block;
        }
        
        /* تحسينات للخطوط العربية */
        .arabic-text {
            font-family: 'Cairo', sans-serif;
            line-height: 1.8;
        }
        
        /* تحسينات للزر المحذوف */
        .delete-product-btn {
            transition: all 0.3s ease;
        }
        
        .delete-product-btn:hover {
            transform: scale(1.2);
            color: #dc2626 !important;
        }
        
        /* تحسينات لحقل البريد الإلكتروني */
        .email-validation {
            display: none;
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* User Invoices Section */
        .user-invoices-section {
            transition: all 0.3s ease;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center">

    <!-- Global Notification Bar -->
    <div id="notification-bar"
        class="notification-bar p-4 rounded-lg text-center font-bold text-white shadow-xl transition-all duration-300 ease-in-out transform">
    </div>

    <!-- Header Section -->
    <header class="w-full bg-white shadow-lg py-4 px-6 md:px-12 flex justify-between items-center rounded-b-xl z-10">
        <h1 class="text-3xl font-bold text-pink-600">
            <i class="fas fa-magic"></i> متجر الجمال
        </h1>
        <nav class="space-x-4 space-x-reverse hidden md:flex items-center">
            <button id="show-user-view"
                class="text-gray-700 hover:text-pink-600 transition duration-300 ease-in-out font-semibold">المتجر</button>
            <button id="show-admin-view"
                class="text-gray-700 hover:text-pink-600 transition duration-300 ease-in-out font-semibold">لوحة
                التحكم</button>
            <button id="show-cart-btn"
                class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition duration-300 ease-in-out shadow-md font-semibold flex items-center">
                <i class="fas fa-shopping-cart ml-2"></i> سلة التسوق (<span id="cart-count">0</span>)
            </button>
            <button id="logout-btn"
                class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 ease-in-out shadow-md font-semibold hidden">
                <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
            </button>
        </nav>
        <div class="md:hidden flex items-center">
            <button id="show-cart-mobile"
                class="bg-pink-600 text-white p-3 rounded-full hover:bg-pink-700 transition duration-300 ease-in-out shadow-md flex items-center">
                <i class="fas fa-shopping-cart"></i> (<span id="cart-count-mobile">0</span>)
            </button>
            <button id="mobile-menu-btn" class="text-gray-700 text-2xl ml-4">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden w-full bg-white shadow-lg p-4 mt-2 rounded-lg md:hidden">
        <nav class="flex flex-col space-y-2 text-right">
            <button id="show-user-view-mobile"
                class="text-gray-700 hover:text-pink-600 transition duration-300 ease-in-out font-semibold text-lg py-2">المتجر</button>
            <button id="show-admin-view-mobile"
                class="text-gray-700 hover:text-pink-600 transition duration-300 ease-in-out font-semibold text-lg py-2">لوحة
                التحكم</button>
            <button id="logout-btn-mobile"
                class="bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-300 ease-in-out font-semibold hidden text-lg">
                <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
            </button>
        </nav>
    </div>

    <!-- Login/Register/Admin Login Section -->
    <main id="auth-section"
        class="flex-grow flex flex-col justify-center items-center p-6 w-full max-w-lg mt-8 md:mt-16">
        <!-- Login Form -->
        <div id="login-section" class="bg-white p-8 rounded-xl shadow-2xl w-full">
            <h2 class="text-3xl font-bold text-center text-pink-600 mb-6">تسجيل الدخول</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-gray-700 font-medium mb-1">البريد الإلكتروني</label>
                    <input type="email" id="login-email"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل بريدك الإلكتروني" required>
                    <div id="login-email-validation" class="email-validation">
                        يرجى استخدام حساب Gmail صالح
                    </div>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 font-medium mb-1">كلمة المرور</label>
                    <input type="password" id="login-password"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل كلمة المرور" required>
                </div>
                <button type="submit"
                    class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">تسجيل
                    الدخول</button>
            </form>
            <div class="mt-6 text-center text-gray-600">
                <button id="show-register-btn" class="text-pink-600 hover:underline">ليس لديك حساب؟
                    سجل الآن</button>
            </div>
            <div class="mt-4 text-center text-gray-600">
                <button id="show-admin-login-btn" class="text-gray-500 hover:underline">تسجيل دخول المسؤول</button>
            </div>
        </div>

        <!-- Register Form -->
        <div id="register-section" class="bg-white p-8 rounded-xl shadow-2xl w-full hidden">
            <h2 class="text-3xl font-bold text-center text-pink-600 mb-6">إنشاء حساب</h2>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-gray-700 font-medium mb-1">الاسم</label>
                    <input type="text" id="register-name"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل اسمك" required>
                </div>
                <div>
                    <label for="register-email" class="block text-gray-700 font-medium mb-1">البريد الإلكتروني</label>
                    <input type="email" id="register-email"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل بريدك الإلكتروني" required>
                    <div id="register-email-validation" class="email-validation">
                        يرجى استخدام حساب Gmail صالح (مثال: example@gmail.com)
                    </div>
                </div>
                <div>
                    <label for="register-password" class="block text-gray-700 font-medium mb-1">كلمة المرور</label>
                    <input type="password" id="register-password"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل كلمة المرور" required>
                </div>
                <button type="submit"
                    class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">إنشاء
                    الحساب</button>
            </form>
            <div class="mt-6 text-center text-gray-600">
                <button id="show-login-btn" class="text-pink-600 hover:underline">لديك حساب بالفعل؟
                    سجل الدخول</button>
            </div>
        </div>

        <!-- Admin Login Form -->
        <div id="admin-login-section" class="bg-white p-8 rounded-xl shadow-2xl w-full hidden">
            <h2 class="text-3xl font-bold text-center text-pink-600 mb-6">تسجيل دخول المسؤول</h2>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label for="admin-email" class="block text-gray-700 font-medium mb-1">البريد الإلكتروني</label>
                    <input type="email" id="admin-email"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل بريد المسؤول" required>
                </div>
                <div>
                    <label for="admin-password" class="block text-gray-700 font-medium mb-1">كلمة المرور</label>
                    <input type="password" id="admin-password"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        placeholder="أدخل كلمة مرور المسؤول" required>
                </div>
                <button type="submit"
                    class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">تسجيل
                    الدخول</button>
            </form>
            <div class="mt-6 text-center text-gray-600">
                <button id="show-user-login-btn" class="text-pink-600 hover:underline">تسجيل دخول المستخدم</button>
            </div>
        </div>
    </main>

    <!-- User Section -->
    <main id="user-section" class="flex-grow flex flex-col items-center w-full p-6">
        <div class="w-full max-w-7xl">
            <h2 class="text-3xl font-bold text-pink-600 text-center mb-8">استكشف منتجاتنا</h2>

            <!-- Search and Filter Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-wrap items-center justify-between gap-4">
                <div class="relative w-full md:w-1/2">
                    <input type="text" id="product-search" placeholder="ابحث عن منتج..."
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex flex-wrap items-center gap-4">
                    <select id="category-filter"
                        class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                        <option value="all">جميع الفئات</option>
                    </select>
                    <div class="flex items-center gap-2 text-gray-700">
                        <label for="price-filter">السعر:</label>
                        <input type="range" id="price-filter" min="10" max="200" value="200"
                            class="w-24 md:w-32">
                        <span id="price-value">200 د.أ</span>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Products will be injected here by JavaScript -->
            </div>

            <!-- زر لعرض الفواتير في واجهة المستخدم -->
            <div class="text-center mt-8">
                <button id="show-user-invoices" 
                        class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition duration-300 shadow-md">
                    <i class="fas fa-file-invoice ml-2"></i> عرض فواتيري
                </button>
            </div>

            <!-- User Invoices Section -->
            <div id="user-invoices" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
                <h3 class="text-2xl font-bold text-pink-600 mb-4">فواتيري</h3>
                <div id="user-invoices-list" class="space-y-4">
                    <!-- الفواتير ستظهر هنا -->
                </div>
            </div>
        </div>
    </main>

    <!-- Admin Section -->
    <main id="admin-section" class="flex-grow flex flex-col items-center w-full p-6">
        <div class="w-full max-w-7xl">
            <h2 class="text-3xl font-bold text-pink-600 text-center mb-8">لوحة تحكم المسؤول</h2>

            <!-- Admin Stats and Actions -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex-1 bg-pink-100 p-4 rounded-lg text-center shadow-inner">
                    <h3 class="text-xl font-semibold text-pink-700">إجمالي المبيعات</h3>
                    <p id="total-sales" class="text-2xl font-bold text-pink-900 mt-2">0 د.أ</p>
                </div>
                <button id="add-product-btn"
                    class="bg-pink-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-pink-700 transition duration-300 shadow-md">
                    <i class="fas fa-plus-circle ml-2"></i> إضافة منتج جديد
                </button>
                <button id="view-invoices-btn"
                    class="bg-gray-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-600 transition duration-300 shadow-md">
                    <i class="fas fa-file-invoice-dollar ml-2"></i> عرض الفواتير
                </button>
            </div>

            <!-- Product Management Table -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">إدارة المنتجات</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-right">المنتج</th>
                                <th class="py-3 px-6 text-center">الكمية</th>
                                <th class="py-3 px-6 text-center">السعر (د.أ)</th>
                                <th class="py-3 px-6 text-center">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-list" class="text-gray-600 text-sm font-light">
                            <!-- Products will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Delivery Orders Section -->
            <div class="delivery-orders bg-white p-6 rounded-xl shadow-lg mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">إدارة طلبات التوصيل</h3>
                <div id="delivery-orders-list">
                    <!-- طلبات التوصيل ستظهر هنا -->
                </div>
            </div>
        </div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal">
        <div class="modal-content md:max-w-3xl">
            <span class="close-button" onclick="closeModal('cart-modal')">&times;</span>
            <h2 class="text-3xl font-bold text-pink-600 mb-6 text-center">سلة التسوق</h2>
            <div id="cart-items" class="space-y-4">
                <!-- Cart items will be injected here -->
            </div>
            <div class="border-t border-gray-200 mt-6 pt-4 flex justify-between items-center">
                <span class="text-xl font-semibold text-gray-800">الإجمالي: <span id="cart-total"
                        class="text-pink-600">0.00 د.أ</span></span>
                <button id="proceed-to-delivery-btn"
                    class="bg-pink-600 text-white px-6 py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">
                    <i class="fas fa-truck ml-2"></i> متابعة إلى التوصيل
                </button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="product-details-modal" class="modal">
        <div class="modal-content md:max-w-4xl flex flex-col md:flex-row gap-8">
            <span class="close-button" onclick="closeModal('product-details-modal')">&times;</span>
            <div class="md:w-1/2 flex justify-center items-center">
                <img id="details-image" src="" alt="Product Image" class="w-full max-h-96 object-contain rounded-lg shadow-md">
            </div>
            <div class="md:w-1/2 space-y-4 text-right">
                <h2 id="details-name" class="text-4xl font-bold text-pink-600"></h2>
                <p id="details-category" class="text-gray-500 font-semibold"></p>
                <p id="details-description" class="text-gray-700 leading-relaxed"></p>
                <div class="flex items-center space-x-2 space-x-reverse text-xl text-yellow-400">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                    <span id="details-rating" class="text-gray-600 font-bold ml-2">(4.5)</span>
                </div>
                <div class="text-3xl font-bold text-gray-900">
                    <span id="details-price"></span>
                </div>
                <button id="add-to-cart-details-btn"
                    class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">
                    <i class="fas fa-shopping-cart ml-2"></i> أضف إلى السلة
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-form-modal" class="modal">
        <div class="modal-content md:max-w-2xl">
            <span class="close-button" onclick="closeModal('product-form-modal')">&times;</span>
            <h2 id="product-form-title" class="text-3xl font-bold text-pink-600 mb-6 text-center">إضافة منتج جديد</h2>
            <form id="product-form" class="space-y-4">
                <div>
                    <label for="product-name" class="block text-gray-700 font-medium mb-1">اسم المنتج</label>
                    <input type="text" id="product-name"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        required>
                </div>
                <div>
                    <label for="product-category" class="block text-gray-700 font-medium mb-1">الفئة</label>
                    <input type="text" id="product-category"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        required>
                </div>
                <div>
                    <label for="product-description" class="block text-gray-700 font-medium mb-1">الوصف</label>
                    <textarea id="product-description"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500 h-24"
                        required></textarea>
                </div>
                <div>
                    <label for="product-image" class="block text-gray-700 font-medium mb-1">رابط الصورة</label>
                    <input type="url" id="product-image"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-price" class="block text-gray-700 font-medium mb-1">السعر (د.أ)</label>
                        <input type="number" id="product-price" min="0" step="0.01"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="product-stock" class="block text-gray-700 font-medium mb-1">الكمية في المخزون</label>
                        <input type="number" id="product-stock" min="0"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500"
                            required>
                    </div>
                </div>
                <button type="submit" id="save-product-btn"
                    class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">حفظ
                    المنتج</button>
            </form>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content md:max-w-4xl">
            <span class="close-button" onclick="closeModal('invoice-modal')">&times;</span>
            <div id="invoice-content" class="p-8 text-right">
                <!-- Invoice details will be generated here -->
            </div>
            <div class="flex justify-center mt-6">
                <button id="print-invoice-btn"
                    class="bg-pink-600 text-white px-6 py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">
                    <i class="fas fa-print ml-2"></i> طباعة الفاتورة
                </button>
            </div>
        </div>
    </div>

    <!-- Invoices Modal -->
    <div id="invoices-modal" class="modal">
        <div class="modal-content md:max-w-4xl">
            <span class="close-button" onclick="closeModal('invoices-modal')">&times;</span>
            <h2 class="text-3xl font-bold text-pink-600 mb-6 text-center">جميع الفواتير</h2>
            <div id="invoices-list" class="space-y-4">
                <!-- Invoices will be injected here -->
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content md:max-w-4xl">
            <span class="close-button" onclick="closeModal('delivery-modal')">&times;</span>
            <h2 class="text-3xl font-bold text-pink-600 mb-6 text-center">تأكيد التوصيل</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-4">حدد موقع التوصيل على الخريطة</h3>
                <div id="delivery-map" class="delivery-map"></div>
            </div>

            <div class="address-form">
                <h3 class="text-xl font-semibold mb-4">معلومات العنوان والاتصال</h3>
                <form id="address-form" class="space-y-4">
                    <!-- إضافة حقل رقم الهاتف هنا -->
                    <div class="form-grid">
                        <div>
                            <label for="phone-number" class="block text-gray-700 font-medium mb-1">رقم الهاتف</label>
                            <input type="tel" id="phone-number" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="أدخل رقم هاتفك" required>
                        </div>
                        <div>
                            <label for="street-name" class="block text-gray-700 font-medium mb-1">اسم الشارع</label>
                            <input type="text" id="street-name" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div>
                            <label for="building-number" class="block text-gray-700 font-medium mb-1">رقم العمارة</label>
                            <input type="text" id="building-number" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="apartment-number" class="block text-gray-700 font-medium mb-1">رقم الشقة (اختياري)</label>
                            <input type="text" id="apartment-number" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div>
                            <label for="additional-info" class="block text-gray-700 font-medium mb-1">معلومات إضافية (اختياري)</label>
                            <input type="text" id="additional-info" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                    </div>

                    <div class="flex items-center mt-4">
                        <input type="checkbox" id="cash-on-delivery" class="w-5 h-5 text-pink-600 rounded focus:ring-pink-500" checked>
                        <label for="cash-on-delivery" class="mr-2 text-gray-700 font-medium">الدفع عند الاستلام</label>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-lg">
                            <i class="fas fa-check-circle ml-2"></i> تأكيد الطلب والتوصيل
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content max-w-md text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">تأكيد الحذف</h2>
            <p id="delete-confirm-message" class="text-gray-600 mb-6">هل أنت متأكد من رغبتك في حذف هذا المنتج؟</p>
            <div class="flex justify-center space-x-4 space-x-reverse">
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300">
                    نعم، حذف
                </button>
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Global state variables
        const state = {
            products: [],
            cart: [],
            invoices: [],
            deliveryOrders: [],
            currentUser: null,
            isAdmin: false,
            editingProductId: null,
            deletingProductId: null,
            currentInvoice: null,
            users: {
                'user@gmail.com': 'password123',
                'admin@gmail.com': 'admin123'
            },
            demoProducts: [{
                id: 1,
                name: 'كريم مرطب',
                description: 'كريم مرطب للوجه والجسم بتركيبة غنية وفيتامين E.',
                image: 'https://placehold.co/400x400/90c79d/ffffff?text=Product+1',
                price: 18.00,
                stock: 50,
                category: 'العناية بالبشرة',
                rating: 4.5
            }, {
                id: 2,
                name: 'أحمر شفاه سائل',
                description: 'أحمر شفاه سائل بلمسة نهائية مات تدوم طويلاً.',
                image: 'https://placehold.co/400x400/c79db3/ffffff?text=Product+2',
                price: 13.00,
                stock: 30,
                category: 'المكياج',
                rating: 4.7
            }, {
                id: 3,
                name: 'عطر زهري',
                description: 'عطر برائحة زهرية منعشة مثالي للاستخدام اليومي.',
                image: 'https://placehold.co/400x400/9dc7c0/ffffff?text=Product+3',
                price: 46.00,
                stock: 20,
                category: 'العطور',
                rating: 4.9
            }, {
                id: 4,
                name: 'مقشر للجسم',
                description: 'مقشر لطيف للجسم يزيل الجلد الميت ويترك البشرة ناعمة.',
                image: 'https://placehold.co/400x400/c79d90/ffffff?text=Product+4',
                price: 25.00,
                stock: 40,
                category: 'العناية بالجسم',
                rating: 4.2
            }, {
                id: 5,
                name: 'ماسكارا مكثفة',
                description: 'ماسكارا تمنح رموشك حجماً وكثافة فائقة دون تكتل.',
                image: 'https://placehold.co/400x400/9d90c7/ffffff?text=Product+5',
                price: 16.00,
                stock: 60,
                category: 'المكياج',
                rating: 4.6
            }, {
                id: 6,
                name: 'غسول للوجه',
                description: 'غسول عميق لتنظيف المسام وإزالة الشوائب.',
                image: 'https://placehold.co/400x400/90c79d/ffffff?text=Product+6',
                price: 11.00,
                stock: 55,
                category: 'العناية بالبشرة',
                rating: 4.3
            }, {
                id: 7,
                name: 'ظلال عيون',
                description: 'باليت ظلال عيون بألوان غنية ولامعة لإطلالة مميزة.',
                image: 'https://placehold.co/400x400/c79db3/ffffff?text=Product+7',
                price: 32.00,
                stock: 25,
                category: 'المكياج',
                rating: 4.8
            }, {
                id: 8,
                name: 'كريم أساس',
                description: 'كريم أساس بتركيبة خفيفة تغطي العيوب وتمنح بشرتك مظهراً طبيعياً.',
                image: 'https://placehold.co/400x400/9dc7c0/ffffff?text=Product+8',
                price: 21.00,
                stock: 35,
                category: 'المكياج',
                rating: 4.5
            }, ],
        };

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const userSection = document.getElementById('user-section');
        const adminSection = document.getElementById('admin-section');
        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');
        const adminLoginSection = document.getElementById('admin-login-section');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');

        const productList = document.getElementById('product-list');
        const cartCount = document.getElementById('cart-count');
        const cartCountMobile = document.getElementById('cart-count-mobile');
        const cartTotal = document.getElementById('cart-total');
        const proceedToDeliveryBtn = document.getElementById('proceed-to-delivery-btn');

        const adminProductList = document.getElementById('admin-product-list');
        const totalSalesElement = document.getElementById('total-sales');
        const notificationBar = document.getElementById('notification-bar');

        const cartModal = document.getElementById('cart-modal');
        const productDetailsModal = document.getElementById('product-details-modal');
        const productFormModal = document.getElementById('product-form-modal');
        const invoiceModal = document.getElementById('invoice-modal');
        const invoicesModal = document.getElementById('invoices-modal');
        const deliveryModal = document.getElementById('delivery-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');

        const priceFilter = document.getElementById('price-filter');
        const priceValue = document.getElementById('price-value');
        const categoryFilter = document.getElementById('category-filter');
        const productSearch = document.getElementById('product-search');

        // --- Delivery System Variables ---
        let deliveryMap;
        let deliveryMarker;
        let userLocation = null;

        // --- Functions ---

        // التحقق من صحة البريد الإلكتروني (Gmail فقط)
        function isValidGmail(email) {
            const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
            return gmailRegex.test(email);
        }

        // Display notification
        function showNotification(message, type = 'success') {
            notificationBar.textContent = message;
            notificationBar.className = 'notification-bar show animate';
            if (type === 'success') {
                notificationBar.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationBar.classList.add('bg-red-500');
            } else if (type === 'info') {
                notificationBar.classList.add('bg-blue-500');
            }
            setTimeout(() => {
                notificationBar.classList.remove('show', 'animate');
            }, 3000);
        }

        // --- View & State Management ---

// إذا الجهاز معرف كجهاز مسؤول، نفتح لوحة التحكم مباشرة
const isAdminDeviceStored = localStorage.getItem('isAdminDevice') === 'true';
if (isAdminDeviceStored) {
    state.isAdmin = true;
    if (!state.currentUser) {
        state.currentUser = 'admin@gmail.com';
    }
}


        function updateView() {
            authSection.classList.add('hidden');
            userSection.classList.add('hidden');
            adminSection.classList.add('hidden');

            if (state.currentUser) {
                logoutBtn.classList.remove('hidden');
                logoutBtnMobile.classList.remove('hidden');
                if (state.isAdmin) {
                    adminSection.classList.remove('hidden');
                    renderAdminDashboard();
                } else {
                    userSection.classList.remove('hidden');
                    renderProducts();
                }
            } else {
                authSection.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                logoutBtnMobile.classList.add('hidden');
            }
        }

        function showSection(sectionId) {
            loginSection.classList.add('hidden');
            registerSection.classList.add('hidden');
            adminLoginSection.classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // --- User/Admin Authentication ---

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // التحقق من أن البريد الإلكتروني هو Gmail
            if (!isValidGmail(email)) {
                document.getElementById('login-email-validation').style.display = 'block';
                showNotification('يجب استخدام حساب Gmail صالح لتسجيل الدخول.', 'error');
                return;
            } else {
                document.getElementById('login-email-validation').style.display = 'none';
            }
            
            if (state.users[email] === password) {
                state.currentUser = email;
                state.isAdmin = (email === 'admin@gmail.com');
                showNotification('تم تسجيل الدخول بنجاح!');
                
                // تنظيف بيانات التخزين المحلي للمستخدم السابق
                clearUserData();
                
                // تحميل بيانات المستخدم الجديد
                loadUserData();
                
                updateView();
            } else {
                showNotification('خطأ في البريد الإلكتروني أو كلمة المرور.', 'error');
            }
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            // التحقق من أن البريد الإلكتروني هو Gmail
            if (!isValidGmail(email)) {
                document.getElementById('register-email-validation').style.display = 'block';
                showNotification('يجب استخدام حساب Gmail صالح للتسجيل.', 'error');
                return;
            } else {
                document.getElementById('register-email-validation').style.display = 'none';
            }
            
            if (state.users[email]) {
                showNotification('هذا البريد الإلكتروني مستخدم بالفعل.', 'error');
            } else {
                state.users[email] = password;
                state.currentUser = email;
                state.isAdmin = false;
                showNotification('تم إنشاء الحساب بنجاح!');
                
                // تنظيف بيانات التخزين المحلي للمستخدم السابق
                clearUserData();
                
                updateView();
            }
        });

        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            if (email === 'admin@gmail.com' && password === 'admin123') {
                state.currentUser = email;
                state.isAdmin = true;
                showNotification('تم تسجيل دخول المسؤول بنجاح!');
                // إذا تسجيل دخول مسؤول من هذا الجهاز نخزن علامة في localStorage
                localStorage.setItem('isAdminDevice', 'true');

                
                // تنظيف بيانات التخزين المحلي للمستخدم السابق
                clearUserData();
                
                updateView();
            } else {
                showNotification('بيانات المسؤول غير صحيحة.', 'error');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            state.currentUser = null;
            state.isAdmin = false;
            showNotification('تم تسجيل الخروج بنجاح!');
            
            // تنظيف بيانات التخزين المحلي عند تسجيل الخروج
            clearUserData();
            
            updateView();
        });

        document.getElementById('logout-btn-mobile').addEventListener('click', () => {
            state.currentUser = null;
            state.isAdmin = false;
            showNotification('تم تسجيل الخروج بنجاح!');
            
            // تنظيف بيانات التخزين المحلي عند تسجيل الخروج
            clearUserData();
            
            updateView();
            toggleMobileMenu();
        });

        // --- تنظيف بيانات المستخدم عند تغيير الحساب ---
        function clearUserData() {
            // مسح سلة التسوق
            state.cart = [];
            updateCartUI();
            
            // مسح بيانات التخزين المحلي
            localStorage.removeItem('cart');
            localStorage.removeItem('userData');
            
            // إعادة تعيين نموذج التوصيل
            if (document.getElementById('address-form')) {
                document.getElementById('address-form').reset();
            }
        }

        // --- Product Rendering & Filtering ---

        function renderProducts() {
            const searchTerm = productSearch.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const maxPrice = parseFloat(priceFilter.value);

            const filteredProducts = state.products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || product.description.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'all' || product.category === selectedCategory;
                const matchesPrice = product.price <= maxPrice;
                return matchesSearch && matchesCategory && matchesPrice;
            });

            productList.innerHTML = '';
            if (filteredProducts.length === 0) {
                productList.innerHTML = '<p class="text-center text-gray-500 text-lg col-span-full">لا توجد منتجات مطابقة.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card bg-white rounded-xl shadow-lg overflow-hidden p-6 text-center transition-transform hover:scale-105';
                const isOutOfStock = product.stock === 0;
                productCard.innerHTML = `
                    <img src="${product.image}" onerror="this.onerror=null;this.src='https://placehold.co/400x400/94a3b8/ffffff?text=Product+Image';" alt="${product.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                    <h3 class="text-xl font-bold text-gray-800">${product.name}</h3>
                    <p class="text-pink-600 font-semibold text-lg mt-2">${product.price.toFixed(2)} د.أ</p>
                    <div class="flex justify-center items-center mt-2 text-yellow-400">
                        ${generateStars(product.rating)}
                        <span class="text-gray-600 font-bold ml-2">(${product.rating})</span>
                    </div>
                    <button class="add-to-cart-btn mt-4 w-full bg-pink-600 text-white py-2 rounded-lg font-bold hover:bg-pink-700 transition duration-300 ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${product.id}" ${isOutOfStock ? 'disabled' : ''}>
                        ${isOutOfStock ? 'نفد المخزون' : 'أضف إلى السلة'}
                    </button>
                    <button class="view-details-btn mt-2 w-full bg-gray-300 text-gray-800 py-2 rounded-lg font-bold hover:bg-gray-400 transition duration-300" data-id="${product.id}">
                        التفاصيل
                    </button>
                `;
                productList.appendChild(productCard);
            });
        }

        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;

            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function populateCategoryFilter() {
            const categories = [...new Set(state.products.map(product => product.category))];
            const categoryFilterSelect = document.getElementById('category-filter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilterSelect.appendChild(option);
            });
        }

        // --- Cart Management ---

        function addToCart(productId) {
            const productIndex = state.products.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showNotification('المنتج غير موجود', 'error');
                return;
            }
            const product = state.products[productIndex];
            if ((Number(product.stock) || 0) <= 0) {
                showNotification('نفد المخزون من هذا المنتج.', 'error');
                return;
            }
            const cartItem = state.cart.find(item => item.id === productId);
            if (cartItem) {
                const currentQty = Number(cartItem.quantity || cartItem.qty || 0);
                if (currentQty < (Number(product.stock) || Infinity)) {
                    cartItem.quantity = currentQty + 1;
                    cartItem.qty = cartItem.quantity;
                } else {
                    showNotification('الكمية المطلوبة أكبر من المخزون', 'error');
                    return;
                }
            } else {
                // Add minimal product info to cart; do not decrement stock yet
                const qty = 1;
                state.cart.push({ id: product.id, name: product.name, price: product.price, quantity: qty, qty: qty, image: product.image || '' });
            }
            // حفظ السلة (سواء مستخدم أم ضيف)
            saveCartToLocalStorage();
            updateCartUI();
            if (typeof renderProducts === 'function') renderProducts();
            if (state.isAdmin && typeof renderAdminProductList === 'function') renderAdminProductList();
        }

        function removeFromCart(productId) {
            const cartItemIndex = state.cart.findIndex(item => item.id === productId);
            if (cartItemIndex !== -1) {
                const cartItem = state.cart[cartItemIndex];
                const productIndex = state.products.findIndex(p => p.id === productId);
                
                if (productIndex !== -1) {
                    // استعادة الكمية إلى المخزون
                    state.products[productIndex].stock += cartItem.quantity;
                }
                
                state.cart.splice(cartItemIndex, 1);
                saveProductsToLocalStorage();
                updateCartUI();
                renderProducts();
                if (state.isAdmin) {
                    renderAdminProductList();
                }
            }
        }

        function updateCartQuantity(productId, newQuantity) {
            const cartItem = state.cart.find(item => item.id === productId);
            const product = state.products.find(p => p.id === productId);
            if (cartItem && product) {
                if (newQuantity > 0 && newQuantity <= product.stock) {
                    // حساب الفرق في الكمية
                    const quantityDifference = newQuantity - cartItem.quantity;
                    cartItem.quantity = newQuantity;
                    
                    // تحديث المخزون
                    const productIndex = state.products.findIndex(p => p.id === productId);
                    if (productIndex !== -1) {
                        state.products[productIndex].stock -= quantityDifference;
                        if (state.products[productIndex].stock < 0) {
                            state.products[productIndex].stock = 0;
                        }
                    }
                } else if (newQuantity === 0) {
                    removeFromCart(productId);
                } else {
                    showNotification('لا يمكن إضافة كمية أكبر من المخزون المتاح.', 'error');
                }
            }
            saveProductsToLocalStorage();
            updateCartUI();
            renderProducts();
            if (state.isAdmin) {
                renderAdminProductList();
            }
        }

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            let total = 0;
            state.cart.forEach(item => {
                const cartItemElement = document.createElement('div');
                cartItemElement.className = 'flex items-center justify-between border-b border-gray-200 pb-4';
                cartItemElement.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg">
                        <div>
                            <h4 class="font-bold text-gray-800">${item.name}</h4>
                            <p class="text-pink-600 font-semibold">${(item.price * item.quantity).toFixed(2)} د.أ</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="decrease-quantity-btn bg-gray-200 p-1 rounded-full w-8 h-8 flex items-center justify-center font-bold hover:bg-gray-300" data-id="${item.id}">-</button>
                        <span class="text-lg font-semibold w-8 text-center">${item.quantity}</span>
                        <button class="increase-quantity-btn bg-gray-200 p-1 rounded-full w-8 h-8 flex items-center justify-center font-bold hover:bg-gray-300" data-id="${item.id}">+</button>
                        <button class="remove-from-cart-btn bg-red-500 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center font-bold hover:bg-red-600" data-id="${item.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItemElement);
                total += item.price * item.quantity;
            });
            cartCount.textContent = state.cart.length;
            cartCountMobile.textContent = state.cart.length;
            cartTotal.textContent = `${total.toFixed(2)} د.أ`;
            proceedToDeliveryBtn.disabled = state.cart.length === 0;
        }

        // --- Admin Dashboard ---

        function renderAdminDashboard() {
            renderAdminProductList();
            updateTotalSales();
            renderDeliveryOrders();
        }

        function renderAdminProductList() {
            adminProductList.innerHTML = '';
            state.products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-right whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="${product.image}" alt="${product.name}" class="w-10 h-10 rounded-full mr-2">
                            <span class="font-medium">${product.name}</span>
                        </div>
                    </td>
                    <td class="py-3 px-6 text-center">
                        <span class="${product.stock === 0 ? 'text-red-600 font-bold' : ''}">
                            ${product.stock}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-center">${product.price.toFixed(2)} د.أ</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2 space-x-reverse">
                            <button class="edit-product-btn w-6 h-6 transform hover:text-pink-500 hover:scale-110" data-id="${product.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-product-btn w-6 h-6 transform hover:text-red-500 hover:scale-110" data-id="${product.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                adminProductList.appendChild(row);
            });
            
            // إضافة event listeners للأزرار
            attachProductEventListeners();
        }
        
        function attachProductEventListeners() {
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.dataset.id);
                    state.editingProductId = productId;
                    const product = state.products.find(p => p.id === productId);
                    if (product) {
                        document.getElementById('product-form-title').textContent = 'تعديل المنتج';
                        document.getElementById('product-name').value = product.name;
                        document.getElementById('product-category').value = product.category;
                        document.getElementById('product-description').value = product.description;
                        document.getElementById('product-price').value = product.price;
                        document.getElementById('product-stock').value = product.stock;
                        document.getElementById('product-image').value = product.image || '';
                        openModal('product-form-modal');
                    }
                });
            });
            
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.dataset.id);
                    state.deletingProductId = productId;
                    const product = state.products.find(p => p.id === productId);
                    if (product) {
                        document.getElementById('delete-confirm-message').textContent = `هل أنت متأكد من رغبتك في حذف المنتج "${product.name}"؟`;
                    }
                    openModal('delete-confirm-modal');
                });
            });
        }

        function updateTotalSales() {
            const totalSales = state.invoices.reduce((sum, invoice) => sum + invoice.total, 0);
            totalSalesElement.textContent = `${totalSales.toFixed(2)} د.أ`;
        }

        // --- Delivery System Functions ---

        // تهيئة الخريطة
        function initMap() {
            deliveryMap = new google.maps.Map(document.getElementById('delivery-map'), {
                center: { lat: 31.9539, lng: 35.9106 }, // مركز الأردن
                zoom: 8
            });

            // جلب الموقع الحالي للمستخدم
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        deliveryMap.setCenter(userLocation);
                        deliveryMap.setZoom(15);
                        
                        deliveryMarker = new google.maps.Marker({
                            position: userLocation,
                            map: deliveryMap,
                            draggable: true,
                            title: 'موقع التوصيل'
                        });

                        deliveryMarker.addListener('dragend', (event) => {
                            userLocation = {
                                lat: event.latLng.lat(),
                                lng: event.latLng.lng()
                            };
                        });
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        showNotification('تعذر الحصول على موقعك. يرجى تحديد الموقع يدوياً على الخريطة.', 'error');
                    }
                );
            }

            deliveryMap.addListener('click', (event) => {
                if (!deliveryMarker) {
                    deliveryMarker = new google.maps.Marker({
                        position: event.latLng,
                        map: deliveryMap,
                        draggable: true
                    });
                } else {
                    deliveryMarker.setPosition(event.latLng);
                }
                userLocation = {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                };
            });
        }

        // modal التوصيل
        function openDeliveryModal() {
            if (state.cart.length === 0) {
                showNotification('سلة التسوق فارغة.', 'error');
                return;
            }
            openModal('delivery-modal');
            
            if (typeof google !== 'undefined' && !deliveryMap) {
                setTimeout(initMap, 100);
            }
        }

        // معالجة نموذج العنوان
        document.getElementById('address-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!userLocation) {
                showNotification('يرجى تحديد موقع التوصيل على الخريطة.', 'error');
                return;
            }

            const phoneNumber = document.getElementById('phone-number').value;
            if (!phoneNumber) {
                showNotification('يرجى إدخال رقم الهاتف.', 'error');
                return;
            }

            const address = {
                phone: phoneNumber,
                street: document.getElementById('street-name').value,
                building: document.getElementById('building-number').value,
                apartment: document.getElementById('apartment-number').value,
                additionalInfo: document.getElementById('additional-info').value,
                location: userLocation,
                cashOnDelivery: document.getElementById('cash-on-delivery').checked
            };

            createDeliveryOrder(address);
        });

        // إنشاء طلب التوصيل
        function createDeliveryOrder(address) {
            const deliveryOrder = {
                id: Date.now(),
                userId: state.currentUser,
                items: [...state.cart],
                total: state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                address: address,
                status: 'pending',
                createdAt: new Date().toLocaleString('ar-SA'),
                invoiceId: null
            };

            state.deliveryOrders.push(deliveryOrder);
            showNotification('تم تأكيد طلب التوصيل بنجاح! سيتم توصيل طلبك قريباً.', 'success');
            
            state.cart = [];
            updateCartUI();
            saveCartToLocalStorage();
            saveDeliveryOrdersToLocalStorage();
            
            closeModal('delivery-modal');
            
            if (state.isAdmin) {
                renderDeliveryOrders();
            }
        }

        // عرض طلبات التوصيل للمسؤول
        function renderDeliveryOrders() {
            const deliveryList = document.getElementById('delivery-orders-list');
            if (!deliveryList) return;

            deliveryList.innerHTML = '';
            
            if (state.deliveryOrders.length === 0) {
                deliveryList.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد طلبات توصيل حالياً.</p>';
                return;
            }

            state.deliveryOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'delivery-card';
                orderCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-bold text-lg">طلب التوصيل #${order.id}</h4>
                            <p class="text-gray-600">العميل: ${order.userId}</p>
                            <p class="text-gray-600">رقم الهاتف: ${order.address.phone}</p>
                            <p class="text-gray-600">التاريخ: ${order.createdAt}</p>
                        </div>
                        <span class="delivery-status status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="font-semibold mb-2">المنتجات:</h5>
                        <ul class="list-disc list-inside mr-4">
                            ${order.items.map(item => `
                                <li>${item.name} - ${item.quantity} × ${item.price.toFixed(2)} د.أ</li>
                            `).join('')}
                        </ul>
                        <p class="font-bold mt-2">المجموع: ${order.total.toFixed(2)} د.أ</p>
                        <p class="text-sm ${order.address.cashOnDelivery ? 'text-green-600' : 'text-blue-600'}">
                            ${order.address.cashOnDelivery ? 'الدفع عند الاستلام' : 'تم الدفع إلكترونياً'}
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="font-semibold mb-2">العنوان:</h5>
                        <p>${order.address.street}, مبنى رقم ${order.address.building}</p>
                        ${order.address.apartment ? `<p>شقة رقم: ${order.address.apartment}</p>` : ''}
                        ${order.address.additionalInfo ? `<p>معلومات إضافية: ${order.address.additionalInfo}</p>` : ''}
                    </div>
                    
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="viewOnMap(${order.id})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-map-marker-alt ml-2"></i> عرض على الخريطة
                        </button>
                        ${order.status === 'pending' ? `
                            <button onclick="markAsProcessing(${order.id})" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">
                                <i class="fas fa-truck-loading ml-2"></i> بدء التوصيل
                            </button>
                        ` : ''}
                        ${order.status === 'processing' ? `
                            <button onclick="completeDelivery(${order.id})" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                <i class="fas fa-check-circle ml-2"></i> تم التوصيل
                            </button>
                        ` : ''}
                    </div>
                `;
                deliveryList.appendChild(orderCard);
            });
        }

        // دوال مساعدة للتوصيل
        function getStatusText(status) {
            const statuses = {
                'pending': 'قيد الانتظار',
                'processing': 'جاري التوصيل',
                'delivered': 'تم التوصيل'
            };
            return statuses[status] || status;
        }

        function viewOnMap(orderId) {
            const order = state.deliveryOrders.find(o => o.id === orderId);
            if (order && order.address.location) {
                const mapUrl = `https://www.google.com/maps?q=${order.address.location.lat},${order.address.location.lng}`;
                window.open(mapUrl, '_blank');
            }
        }

        function markAsProcessing(orderId) {
            const order = state.deliveryOrders.find(o => o.id === orderId);
            if (order) {
                order.status = 'processing';
                renderDeliveryOrders();
                saveDeliveryOrdersToLocalStorage();
                showNotification('تم بدء عملية التوصيل.', 'success');
            }
        }

        function completeDelivery(orderId) {
            const order = state.deliveryOrders.find(o => o.id === orderId);
            if (order) {
                order.status = 'delivered';
                
                const deliveryInvoice = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ar-SA'),
                    items: order.items,
                    total: order.total,
                    user: order.userId,
                    type: 'delivery',
                    deliveryAddress: order.address
                };
                
                deliveryInvoice.items.forEach(item => {
                    const product = state.products.find(p => p.id === item.id);
                    if (product) {
                        product.stock -= item.quantity;
                        if (product.stock < 0) product.stock = 0;
                    }
                });
                
                state.invoices.push(deliveryInvoice);
                updateTotalSales();
                saveProductsToLocalStorage();
                saveInvoicesToLocalStorage();
                saveDeliveryOrdersToLocalStorage();
                
                renderDeliveryOrders();
                renderProducts();
                if (state.isAdmin) {
                    renderAdminProductList();
                }
                showNotification('تم تأكيد التوصيل وإنشاء الفاتورة.', 'success');
            }
        }

        // --- Modals ---

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        function showProductDetails(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            document.getElementById('details-image').src = product.image;
            document.getElementById('details-name').textContent = product.name;
            document.getElementById('details-category').textContent = product.category;
            document.getElementById('details-description').textContent = product.description;
            document.getElementById('details-rating').textContent = `(${product.rating})`;
            document.getElementById('details-price').textContent = `${product.price.toFixed(2)} د.أ`;
            document.getElementById('add-to-cart-details-btn').setAttribute('data-id', product.id);
            openModal('product-details-modal');
        }

        function showInvoice(invoice) {
            state.currentInvoice = invoice;
            const invoiceContent = document.getElementById('invoice-content');
            invoiceContent.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold text-pink-600 mb-2">فاتورة</h2>
                    <p class="text-gray-600">رقم الفاتورة: ${invoice.id}</p>
                    <p class="text-gray-600">التاريخ: ${invoice.date}</p>
                    <p class="text-gray-600">العميل: ${invoice.user}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="py-2 px-4 text-gray-700">المنتج</th>
                                <th class="py-2 px-4 text-gray-700">الكمية</th>
                                <th class="py-2 px-4 text-gray-700">سعر الوحدة</th>
                                <th class="py-2 px-4 text-gray-700">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr class="border-b border-gray-200">
                                    <td class="py-2 px-4">${item.name}</td>
                                    <td class="py-2 px-4">${item.quantity}</td>
                                    <td class="py-2 px-4">${item.price.toFixed(2)} د.أ</td>
                                    <td class="py-2 px-4">${(item.price * item.quantity).toFixed(2)} د.أ</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 text-left border-t-2 border-gray-300 pt-4">
                    <p class="text-xl font-bold text-gray-800">الإجمالي: ${invoice.total.toFixed(2)} د.أ</p>
                </div>
            `;
            openModal('invoice-modal');
        }

        window.printSingleInvoice = function (invoice) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إضافة محتوى الفاتورة بالإنجليزية
            doc.setFontSize(20);
            doc.text("Beauty Store Invoice", 105, 20, { align: "center" });
            
            doc.setFontSize(12);
            doc.text(`Invoice #: ${invoice.id}`, 20, 35);
            doc.text(`Date: ${invoice.date}`, 20, 42);
            doc.text(`Customer: ${invoice.user}`, 20, 49);
            
            // جدول المنتجات
            const tableColumn = ["Product", "Qty", "Unit Price", "Total"];
            const tableRows = invoice.items.map(item => [
                item.name,
                item.quantity,
                `${item.price.toFixed(2)} JOD`,
                `${(item.price * item.quantity).toFixed(2)} JOD`
            ]);
            
            // إضافة الجدول
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 60,
                theme: 'grid',
                headStyles: { 
                    fillColor: [219, 39, 119],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                styles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 30 }
                }
            });
            
            // إجمالي الفاتورة
            const finalY = doc.autoTable.previous.finalY + 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`Total Amount: ${invoice.total.toFixed(2)} JOD`, 20, finalY);
            
            // حفظ الفاتورة كملف PDF
            const fileName = `invoice_${invoice.id}.pdf`;
            doc.save(fileName);
        };

        // عرض فواتير المستخدم
        function renderUserInvoices() {
            const userInvoicesList = document.getElementById('user-invoices-list');
            userInvoicesList.innerHTML = '';
            
            const userInvoices = state.invoices.filter(invoice => invoice.user === state.currentUser);
            
            if (userInvoices.length === 0) {
                userInvoicesList.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد فواتير حتى الآن.</p>';
                return;
            }
            
            userInvoices.forEach(invoice => {
                const invoiceCard = document.createElement('div');
                invoiceCard.className = 'bg-gray-100 p-4 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4';
                invoiceCard.innerHTML = `
                    <div class="flex-1 text-right">
                        <p class="font-bold text-lg text-pink-700">فاتورة #${invoice.id}</p>
                        <p class="text-gray-600">التاريخ: ${invoice.date}</p>
                        <p class="text-gray-600">المجموع: ${invoice.total.toFixed(2)} د.أ</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="view-invoice-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-id="${invoice.id}">
                            <i class="fas fa-eye ml-1"></i> عرض
                        </button>
                        <button class="download-invoice-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-id="${invoice.id}">
                            <i class="fas fa-download ml-1"></i> تحميل
                        </button>
                    </div>
                `;
                userInvoicesList.appendChild(invoiceCard);
            });
            
            // إضافة event listeners للأزرار الجديدة
            document.querySelectorAll('.view-invoice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const invoiceId = parseInt(e.target.closest('button').dataset.id);
                    const invoice = state.invoices.find(inv => inv.id === invoiceId);
                    if (invoice) showInvoice(invoice);
                });
            });
            
            document.querySelectorAll('.download-invoice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const invoiceId = parseInt(e.target.closest('button').dataset.id);
                    const invoice = state.invoices.find(inv => inv.id === invoiceId);
                    if (invoice) window.printSingleInvoice(invoice);
                });
            });
        }

        function renderInvoices() {
            const invoicesList = document.getElementById('invoices-list');
            invoicesList.innerHTML = '';
            if (state.invoices.length === 0) {
                invoicesList.innerHTML = '<p class="text-center text-gray-500 text-lg">لا توجد فواتير حتى الآن.</p>';
                return;
            }

            state.invoices.forEach(invoice => {
                const invoiceCard = document.createElement('div');
                invoiceCard.className = 'bg-gray-100 p-6 rounded-xl shadow-inner flex flex-col md:flex-row justify-between items-center gap-4';
                invoiceCard.innerHTML = `
                    <div class="flex-1 text-right">
                        <p class="font-bold text-lg text-pink-700">فاتورة #${invoice.id}</p>
                        <p class="text-gray-600">التاريخ: ${invoice.date}</p>
                        <p class="text-gray-600">العميل: ${invoice.user}</p>
                    </div>
                    <div class="flex-shrink-0 text-center md:text-left">
                        <p class="text-2xl font-bold text-pink-900">${invoice.total.toFixed(2)} د.أ</p>
                    </div>
                    <div class="flex-shrink-0">
                        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 font-semibold print-invoice-btn" data-id="${invoice.id}">
                            <i class="fas fa-print ml-2"></i> طباعة
                        </button>
                    </div>
                `;
                invoicesList.appendChild(invoiceCard);
            });
        }

        // --- Local Storage Functions ---
        function saveCartToLocalStorage() {
            if (state.currentUser) {
                localStorage.setItem(`cart_${state.currentUser}`, JSON.stringify(state.cart));
            } else {
                // guest cart
                localStorage.setItem('cart', JSON.stringify(state.cart));
            }
        }

        function loadCartFromLocalStorage() {
            if (state.currentUser) {
                const savedCart = localStorage.getItem(`cart_${state.currentUser}`);
                if (savedCart) {
                    state.cart = JSON.parse(savedCart);
                    updateCartUI();
                    return;
                }
            }
            // load guest cart if exists
            const guestCartRaw = localStorage.getItem('cart');
            if (guestCartRaw) {
                try {
                    state.cart = JSON.parse(guestCartRaw);
                    updateCartUI();
                } catch (e) { console.error('failed to parse guest cart', e); }
            }
        }

        function saveProductsToLocalStorage() {
            localStorage.setItem('products', JSON.stringify(state.products));
        }

        function loadProductsFromLocalStorage() {
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                state.products = JSON.parse(savedProducts);
            } else {
                state.products = [...state.demoProducts];
            }
        }

        function saveInvoicesToLocalStorage() {
            localStorage.setItem('invoices', JSON.stringify(state.invoices));
        }

        function loadInvoicesFromLocalStorage() {
            const savedInvoices = localStorage.getItem('invoices');
            if (savedInvoices) {
                state.invoices = JSON.parse(savedInvoices);
            }
        }

        function saveDeliveryOrdersToLocalStorage() {
            localStorage.setItem('deliveryOrders', JSON.stringify(state.deliveryOrders));
        }

        function loadDeliveryOrdersFromLocalStorage() {
            const savedDeliveryOrders = localStorage.getItem('deliveryOrders');
            if (savedDeliveryOrders) {
                state.deliveryOrders = JSON.parse(savedDeliveryOrders);
            }
        }

        // تحميل بيانات المستخدم عند تسجيل الدخول
        function loadUserData() {
            // load either user-specific cart or guest cart
            loadCartFromLocalStorage();
            // if user logged in, try to merge any existing guest cart into their user cart
            if (state.currentUser) {
                const guestRaw = localStorage.getItem('cart');
                if (guestRaw) {
                    try {
                        const guestCart = JSON.parse(guestRaw);
                        guestCart.forEach(gc => {
                            const existing = state.cart.find(i => i.id === gc.id);
                            const addQty = Number(gc.quantity || gc.qty || 1);
                            const prod = state.products.find(p => p.id === gc.id) || {};
                            const available = Number(prod.stock || Infinity);
                            if (existing) {
                                existing.quantity = Math.min((existing.quantity || existing.qty || 0) + addQty, available);
                                existing.qty = existing.quantity;
                            } else {
                                const qty = Math.min(addQty, available);
                                state.cart.push({ id: gc.id, name: gc.name || '', price: gc.price || 0, quantity: qty, qty: qty, image: gc.image || '' });
                            }
                        });
                        saveCartToLocalStorage();
                        localStorage.removeItem('cart');
                        updateCartUI();
                    } catch (e) { console.error('merge guest cart failed', e); }
                }
            }
            // يمكن إضافة تحميل بيانات أخرى خاصة بالمستخدم هنا
        }

        // --- Product Management ---
        function confirmDeleteProduct() {
            const productId = state.deletingProductId;
            if (productId === null) return;

            const product = state.products.find(p => p.id === productId);
            if (!product) {
                showNotification('المنتج غير موجود.', 'error');
                return;
            }

            const isInDelivery = state.deliveryOrders.some(order => 
                order.items.some(item => item.id === productId) && order.status !== 'delivered'
            );
            if (isInDelivery) {
                showNotification('لا يمكن حذف المنتج لأنه جزء من طلب توصيل قيد التنفيذ.', 'error');
                closeModal('delete-confirm-modal');
                return;
            }

            // Perform deletion
            state.products = state.products.filter(p => p.id !== productId);
            if (state.cart.some(item => item.id === productId)) {
                removeFromCart(productId);
            }
            saveProductsToLocalStorage();
            renderAdminDashboard();
            renderProducts();
            showNotification('تم حذف المنتج بنجاح.', 'success');
            
            // Cleanup
            closeModal('delete-confirm-modal');
            state.deletingProductId = null;
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProductsFromLocalStorage();
            loadInvoicesFromLocalStorage();
            loadDeliveryOrdersFromLocalStorage();
            
            populateCategoryFilter();
            updateView();

            document.getElementById('print-invoice-btn').addEventListener('click', () => {
                if (state.currentInvoice) {
                    window.printSingleInvoice(state.currentInvoice);
                } else {
                    showNotification('لا يوجد فاتورة للطباعة.', 'error');
                }
            });
        });

        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);

        priceFilter.addEventListener('input', () => {
            priceValue.textContent = `${priceFilter.value} د.أ`;
            renderProducts();
        });
        categoryFilter.addEventListener('change', renderProducts);
        productSearch.addEventListener('input', renderProducts);

        // View Toggles
        document.getElementById('show-user-view').addEventListener('click', () => {
            if (state.currentUser) {
                state.isAdmin = false;
                updateView();
            } else {
                showNotification('يرجى تسجيل الدخول أولاً.', 'info');
            }
        });

        document.getElementById('show-user-view-mobile').addEventListener('click', () => {
            if (state.currentUser) {
                state.isAdmin = false;
                updateView();
            } else {
                showNotification('يرجى تسجيل الدخول أولاً.', 'info');
            }
            toggleMobileMenu();
        });

        document.getElementById('show-admin-view').addEventListener('click', () => {
            if (state.currentUser && state.users[state.currentUser] === 'admin123') {
                state.isAdmin = true;
                updateView();
            } else if (state.currentUser) {
                showNotification('ليس لديك صلاحية الوصول.', 'error');
            } else {
                showNotification('يرجى تسجيل الدخول كمسؤول أولاً.', 'info');
            }
        });

        document.getElementById('show-admin-view-mobile').addEventListener('click', () => {
            if (state.currentUser && state.users[state.currentUser] === 'admin123') {
                state.isAdmin = true;
                updateView();
            } else if (state.currentUser) {
                showNotification('ليس لديك صلاحية الوصول.', 'error');
            } else {
                showNotification('يرجى تسجيل الدخول كمسؤول أولاً.', 'info');
            }
            toggleMobileMenu();
        });

        // Auth form toggles
        document.getElementById('show-register-btn').addEventListener('click', () => showSection('register-section'));
        document.getElementById('show-login-btn').addEventListener('click', () => showSection('login-section'));
        document.getElementById('show-admin-login-btn').addEventListener('click', () => showSection('admin-login-section'));
        document.getElementById('show-user-login-btn').addEventListener('click', () => showSection('login-section'));

        // Cart and Checkout
        document.getElementById('show-cart-btn').addEventListener('click', () => openModal('cart-modal'));
        document.getElementById('show-cart-mobile').addEventListener('click', () => {
            openModal('cart-modal');
            toggleMobileMenu();
        });
        proceedToDeliveryBtn.addEventListener('click', openDeliveryModal);

        // Product actions delegation
        productList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const productId = parseInt(btn.dataset.id);
            // Guests can add to cart without logging in; only checkout requires authentication
            if (btn.classList.contains('add-to-cart-btn')) {
                addToCart(productId);
            } else if (btn.classList.contains('view-details-btn')) {
                showProductDetails(productId);
            }
        });

        // Cart modal actions delegation
        cartModal.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const productId = parseInt(btn.dataset.id);
            if (btn.classList.contains('increase-quantity-btn')) {
                const item = state.cart.find(p => p.id === productId);
                if (item) updateCartQuantity(productId, item.quantity + 1);
            } else if (btn.classList.contains('decrease-quantity-btn')) {
                const item = state.cart.find(p => p.id === productId);
                if (item) updateCartQuantity(productId, item.quantity - 1);
            } else if (btn.classList.contains('remove-from-cart-btn')) {
                removeFromCart(productId);
            }
        });

        document.getElementById('add-to-cart-details-btn').addEventListener('click', (e) => {
            const productId = parseInt(e.target.dataset.id);
            // Guests can add to cart without logging in; only checkout requires authentication
            addToCart(productId);
            closeModal('product-details-modal');
        });

        // Admin actions
        document.getElementById('add-product-btn').addEventListener('click', () => {
            document.getElementById('product-form-title').textContent = 'إضافة منتج جديد';
            document.getElementById('product-form').reset();
            openModal('product-form-modal');
            state.editingProductId = null;
        });

        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const productData = {
                name: form['product-name'].value,
                category: form['product-category'].value,
                description: form['product-description'].value,
                image: form['product-image'].value,
                price: parseFloat(form['product-price'].value),
                stock: parseInt(form['product-stock'].value),
            };

            if (state.editingProductId) {
                const index = state.products.findIndex(p => p.id === state.editingProductId);
                if (index !== -1) {
                    state.products[index] = { ...state.products[index], ...productData };
                    showNotification('تم تحديث المنتج بنجاح.');
                }
            } else {
                const newProduct = {
                    ...productData,
                    id: state.products.length > 0 ? Math.max(...state.products.map(p => p.id)) + 1 : 1,
                    rating: 5.0,
                };
                state.products.push(newProduct);
                showNotification('تم إضافة المنتج بنجاح.');
            }

            saveProductsToLocalStorage();
            renderAdminDashboard();
            renderProducts();
            closeModal('product-form-modal');
        });

        adminProductList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const productId = parseInt(btn.dataset.id);
            if (btn.classList.contains('edit-product-btn')) {
                state.editingProductId = productId;
                const product = state.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('product-form-title').textContent = 'تعديل المنتج';
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-description').value = product.description;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-stock').value = product.stock;
                    document.getElementById('product-image').value = product.image || '';
                    openModal('product-form-modal');
                }
            } else if (btn.classList.contains('delete-product-btn')) {
                state.deletingProductId = productId;
                const product = state.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('delete-confirm-message').textContent = `هل أنت متأكد من رغبتك في حذف المنتج "${product.name}"؟`;
                }
                openModal('delete-confirm-modal');
            }
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', confirmDeleteProduct);
        document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal('delete-confirm-modal'));

        document.getElementById('view-invoices-btn').addEventListener('click', () => {
            renderInvoices();
            openModal('invoices-modal');
        });

        invoicesModal.addEventListener('click', (e) => {
            const btn = e.target.closest('.print-invoice-btn');
            if (!btn) return;
            const invoiceId = parseInt(btn.dataset.id);
            const invoice = state.invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                window.printSingleInvoice(invoice);
            }
        });

        // User Invoices
        document.getElementById('show-user-invoices').addEventListener('click', () => {
            const userInvoicesSection = document.getElementById('user-invoices');
            userInvoicesSection.classList.toggle('hidden');
            if (!userInvoicesSection.classList.contains('hidden')) {
                renderUserInvoices();
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });
    </script>

<!-- ========================= START: Concurrency-Safe Inventory Module (Firebase) ========================= -->
<!-- 
  ما الجديد هنا؟
  1) إضافة دعم اختياري لـ Firebase Firestore لعمليات شراء ومعالجة المخزون بشكل آمن عند تعدد المستخدمين.
  2) عدم تقليل المخزون عند إضافة المنتج للسلة (addToCart)، بل يتم التقليل الذكي فقط عند تأكيد الدفع عبر معاملة (Transaction).
  3) في حال عدم تهيئة Firebase (ترك الإعدادات فارغة)، سيتحول الكود تلقائيًا لوضع التخزين المحلي القديم (localStorage).

  ملاحظات:
  - تحتاج إلى إنشاء مشروع Firebase وإضافة تطبيق ويب ثم ملء كائن firebaseConfig أدناه.
  - يجب إنشاء مجموعات Firestore التالية: products, orders
    * products/{productId}: { name, price, stock, image, category, createdAt, updatedAt }
    * orders/{orderId}: { userIdOrEmail, items: [{productId, qty, priceAtPurchase}], total, createdAt }
-->

<script type="module">
  // ======== إعدادات Firebase (املأها من لوحة Firebase) ========
  const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
  };

  // استخدم Firebase لو كانت الإعدادات مكتملة
  const USE_FIREBASE = Object.values(firebaseConfig).every(v => typeof v === "string" ? v.trim() !== "" : !!v);

  // تحميل Firebase SDK من CDN عند الحاجة فقط
  if (USE_FIREBASE) {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js");
    const { getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc, addDoc, runTransaction, onSnapshot, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // واجهة رفيعة لطبقة البيانات
    const Products = () => collection(db, "products");
    const Product = (id) => doc(db, "products", id);
    const Orders  = () => collection(db, "orders");

    // بث حي للمنتجات لتحديث الواجهة دائماً
    function subscribeProducts(onChange) {
      return onSnapshot(Products(), (snap) => {
        const products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if (typeof onChange === "function") onChange(products);
      });
    }

    // تحميل المنتجات مرة واحدة
    async function fetchProductsOnce() {
      const snap = await getDocs(Products());
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // إضافة/تعديل منتج (لوحة المسؤول)
    async function upsertProduct(p) {
      if (!p.id) {
        const ref = doc(Products());
        await setDoc(ref, {
          name: p.name,
          price: Number(p.price) || 0,
          stock: Number(p.stock) || 0,
          image: p.image || "",
          category: p.category || "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        return { id: ref.id, ...p };
      } else {
        const ref = Product(p.id);
        await updateDoc(ref, {
          name: p.name,
          price: Number(p.price) || 0,
          stock: Number(p.stock) || 0,
          image: p.image || "",
          category: p.category || "",
          updatedAt: serverTimestamp()
        });
        return p;
      }
    }

    // عملية الشراء بمعاملة ذرّية عبر Firestore
    async function checkoutTransaction(cart, userIdOrEmail) {
      if (!Array.isArray(cart) || cart.length === 0) {
        throw new Error("السلة فارغة.");
      }
      let total = 0;

      await runTransaction(db, async (transaction) => {
        // تحقق وخصم
        for (const item of cart) {
          const pRef = Product(item.id);
          const pSnap = await transaction.get(pRef);
          if (!pSnap.exists()) {
            throw new Error(`المنتج (${item.name || item.id}) غير موجود.`);
          }
          const p = pSnap.data();
          const qty = Number(item.qty) || 0;
          if (qty <= 0) throw new Error("كمية غير صالحة.");

          if (p.stock < qty) {
            throw new Error(`الكمية غير متوفرة للمنتج "${p.name}". المتاح: ${p.stock}, المطلوب: ${qty}`);
          }

          // خصم المخزون
          transaction.update(pRef, {
            stock: p.stock - qty,
            updatedAt: serverTimestamp()
          });

          total += (Number(p.price) || 0) * qty;
        }

        // إنشاء طلب
        await addDoc(Orders(), {
          userIdOrEmail: userIdOrEmail || "guest",
          items: cart.map(c => ({ productId: c.id, qty: Number(c.qty) || 0, priceAtPurchase: Number(c.price) || 0 })),
          total: Number(total.toFixed(2)),
          createdAt: serverTimestamp()
        });
      });

      return { ok: true, total };
    }

    // =============== وصلات مع واجهتك الحالية ===============
    // ملاحظة: الكود أدناه يحاول الاندماج مع دوالك الحالية دون كسرها.
    // - إذا كانت لديك دوال مثل renderProducts, renderCart, loadCart, saveCart, showToast
    //   فسيستدعيها إن وجدت.
    const safe = (fn, ...args) => { try { return typeof fn === "function" ? fn(...args) : undefined; } catch(e) { console.warn(e); } };

    // 1) بث حي للمنتجات
    const stop = subscribeProducts((products) => {
      // نحفظ قائمة المنتجات عالمياً
      window._productsLive = products;
      // إذا عندك رندر
      safe(window.renderProducts, products);
    });

    // 2) استبدال addToCart ليمنع تنزيل المخزون مباشرة
    //    (يعتمد على سلة المتصفح فقط إلى حين الدفع)
    window.addToCart = function(productId, qty = 1) {
      const p = (window._productsLive || []).find(x => x.id === productId);
      if (!p) {
        safe(window.showToast, "المنتج غير موجود", "error");
        return;
      }
      // تحقق سريع من توفر الكمية دون تعديل المخزون بعد
      qty = Number(qty) || 1;
      if (qty <= 0) qty = 1;
      if (p.stock <= 0) {
        safe(window.showToast, "المنتج غير متوفر حالياً", "error");
        return;
      }
      // حدّ أعلى: لا تسمح بتجاوز stock الحالي في السلة نفسها
      const cart = (safe(window.loadCart) || (() => JSON.parse(localStorage.getItem("cart") || "[]")))();
      const existing = cart.find(c => c.id === productId);
      const currentQty = (existing?.qty || 0) + qty;
      if (currentQty > p.stock) {
        safe(window.showToast, `لا يمكنك إضافة ${currentQty}، المتاح ${p.stock}`, "warning");
        return;
      }
      // حدّث السلة فقط
      if (existing) {
        existing.qty = currentQty;
      } else {
        cart.push({ id: p.id, name: p.name, price: p.price, qty });
      }
      if (typeof window.saveCart === "function") {
        window.saveCart(cart);
      } else {
        localStorage.setItem("cart", JSON.stringify(cart));
      }
      safe(window.renderCart, cart);
      safe(window.showToast, "تمت الإضافة إلى السلة", "success");
    };

    // 3) تنفيذ الدفع عبر معاملة Firestore؛ عند النجاح يتم تفريغ السلة
    window.checkout = async function(userIdOrEmail) {
      const cart = (safe(window.loadCart) || (() => JSON.parse(localStorage.getItem("cart") || "[]")))();
      try {
        const res = await checkoutTransaction(cart, userIdOrEmail || (window.currentUser?.email) || "guest");
        if (res.ok) {
          if (typeof window.saveCart === "function") {
            window.saveCart([]);
          } else {
            localStorage.setItem("cart", "[]");
          }
          safe(window.renderCart, []);
          safe(window.showToast, `تمت عملية الشراء بنجاح. الإجمالي: ${res.total}`, "success");
          // إعادة تحميل المنتجات بعد الخصم
          const latest = await fetchProductsOnce();
          window._productsLive = latest;
          safe(window.renderProducts, latest);
        }
      } catch (err) {
        console.error(err);
        safe(window.showToast, err.message || "فشل إتمام العملية", "error");
      }
    };

    // 4) دوال للمسؤول لإضافة/تعديل المنتجات مع مخزون
    window.adminSaveProduct = async function(formData) {
      // formData: {id?, name, price, stock, image, category}
      try {
        const saved = await upsertProduct(formData);
        safe(window.showToast, "تم حفظ المنتج", "success");
        // سيصل التحديث تلقائياً عبر onSnapshot
        return saved;
      } catch (e) {
        console.error(e);
        safe(window.showToast, "تعذر حفظ المنتج", "error");
      }
    };

    // 5) تنظيف عند مغادرة الصفحة
    window.addEventListener("beforeunload", () => { try { stop && stop(); } catch(_){} });

    console.info("✅ تم تفعيل وضع التزامن الآمن عبر Firebase Firestore.");
  } else {
    // ======== وضع محلي قديم (لا يضمن التزامن بين عدة مستخدمين) ========
    // هنا نضمن على الأقل: عدم خصم المخزون عند addToCart، والخصم فقط عند checkout محلياً.
    console.warn("⚠️ Firebase غير مفعّل. سيتم استخدام التخزين المحلي فقط (لا تزامن بين المستخدمين).");

    const safe = (fn, ...args) => { try { return typeof fn === "function" ? fn(...args) : undefined; } catch(e) { console.warn(e); } };

    window.addToCart = function(productId, qty = 1) {
      const products = window.products || window._productsLive || JSON.parse(localStorage.getItem("products") || "[]");
      const p = products.find(x => x.id === productId || x.productId === productId);
      if (!p) { safe(window.showToast, "المنتج غير موجود", "error"); return; }
      qty = Number(qty) || 1;
      const cart = (safe(window.loadCart) || (() => JSON.parse(localStorage.getItem("cart") || "[]")))();
      const existing = cart.find(c => c.id === (p.id || p.productId));
      const currentQty = (existing?.qty || 0) + qty;
      const stock = Number(p.stock) || 0;
      if (stock && currentQty > stock) { safe(window.showToast, `لا يمكنك إضافة ${currentQty}، المتاح ${stock}`, "warning"); return; }
      if (existing) existing.qty = currentQty; else cart.push({ id: (p.id || p.productId), name: p.name, price: p.price, qty });
      if (typeof window.saveCart === "function") window.saveCart(cart); else localStorage.setItem("cart", JSON.stringify(cart));
      safe(window.renderCart, cart);
      safe(window.showToast, "تمت الإضافة إلى السلة", "success");
    };

    window.checkout = function(userIdOrEmail) {
      const products = window.products || window._productsLive || JSON.parse(localStorage.getItem("products") || "[]");
      const cart = (safe(window.loadCart) || (() => JSON.parse(localStorage.getItem("cart") || "[]")))();
      // تحقق محلي فقط
      for (const item of cart) {
        const p = products.find(x => (x.id || x.productId) === item.id);
        if (!p) { safe(window.showToast, `منتج غير موجود`, "error"); return; }
        const stock = Number(p.stock) || 0;
        if (stock < item.qty) { safe(window.showToast, `غير متوفر: ${p.name}`, "error"); return; }
      }
      // خصم محلي
      for (const item of cart) {
        const p = products.find(x => (x.id || x.productId) === item.id);
        p.stock = (Number(p.stock) || 0) - (Number(item.qty) || 0);
      }
      localStorage.setItem("products", JSON.stringify(products));
      if (typeof window.saveCart === "function") window.saveCart([]); else localStorage.setItem("cart", "[]");
      safe(window.renderProducts, products);
      safe(window.renderCart, []);
      safe(window.showToast, "تمت عملية الشراء محليًا", "success");
    };
  }
</script>
<!-- ========================= END: Concurrency-Safe Inventory Module (Firebase) ========================= -->


<script type="module">
/* Firebase integration (v9 modular) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {"apiKey": "AIzaSyAnz0s5Uyo8FSSk8zrul-dmCZjvUokJgXY", "authDomain": "mystore-5c9fa.firebaseapp.com", "projectId": "mystore-5c9fa", "storageBucket": "mystore-5c9fa.firebasestorage.app", "messagingSenderId": "332454966205", "appId": "1:332454966205:web:6a9f92532aaa88a80918d4", "measurementId": "G-EE7L4JQ5FV"};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

console.info('Firebase initialized:', firebaseConfig.projectId);

// Helper: save cart to Firestore under collection 'carts' doc id = user email (sanitized)
function cartDocId(email){ return (email || '').replace('@','__at__'); }

async function saveCartToFirestore(){
    if(!state.currentUser) return;
    try{
        const docRef = doc(db, 'carts', cartDocId(state.currentUser));
        await setDoc(docRef, { items: state.cart || [], updatedAt: serverTimestamp() });
        console.info('Cart saved to Firestore for', state.currentUser);
    }catch(err){ console.error('saveCartToFirestore error', err); }
}

async function loadCartFromFirestore(){
    if(!state.currentUser) return;
    try{
        const docRef = doc(db, 'carts', cartDocId(state.currentUser));
        const snap = await getDoc(docRef);
        if(snap.exists()){
            const data = snap.data();
            if(Array.isArray(data.items)){
                state.cart = data.items.map(it=>({ ...it }));
                saveCartToLocalStorage(); // keep local copy too
                updateCartUI();
                console.info('Loaded cart from Firestore for', state.currentUser);
                return;
            }
        }
    }catch(err){ console.error('loadCartFromFirestore error', err); }
    // fallback to local
    loadCartFromLocalStorage();
}

// Merge guest cart into Firestore cart on login
async function mergeGuestCartIntoFirestore(){
    try{
        const guestRaw = localStorage.getItem('cart');
        if(!guestRaw) return;
        const guestCart = JSON.parse(guestRaw);
        await loadCartFromFirestore(); // load existing into state.cart
        // merge
        guestCart.forEach(gc=>{
            const existing = state.cart.find(i=>i.id===gc.id);
            const addQty = Number(gc.quantity||gc.qty||1);
            const prod = state.products.find(p=>p.id===gc.id) || {};
            const available = Number(prod.stock || Infinity);
            if(existing){
                existing.quantity = Math.min((existing.quantity||existing.qty||0)+addQty, available);
                existing.qty = existing.quantity;
            } else {
                const qty = Math.min(addQty, available);
                state.cart.push({ id: gc.id, name: gc.name||'', price: gc.price||0, quantity: qty, qty: qty, image: gc.image||'' });
            }
        });
        await saveCartToFirestore();
        localStorage.removeItem('cart');
        updateCartUI();
    }catch(err){ console.error('mergeGuestCartIntoFirestore', err); }
}

// Override or add event listeners to forms to use Firebase Auth
function safeAddListener(id, type, handler, capture=false){ const el = document.getElementById(id); if(el){ el.addEventListener(type, async (e)=>{ e.stopImmediatePropagation(); return handler(e); }, capture); } }

// Register form -> create user in Firebase Auth then create user doc
safeAddListener('register-form', 'submit', async (e) => {
    e.preventDefault();
    const email = (document.getElementById('register-email').value || '').trim();
    const password = document.getElementById('register-password').value || '';
    const name = document.getElementById('register-name').value || '';
    try{
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        // create a simple user doc
        await setDoc(doc(db, 'users', cartDocId(userCred.user.email)), { email: userCred.user.email, name: name, createdAt: serverTimestamp() });
        state.currentUser = userCred.user.email;
        state.isAdmin = false;
        await saveCartToFirestore(); // ensure cart exists
        showNotification('تم إنشاء الحساب وتسجيل الدخول بنجاح','success');
        loadUserData(); // loads from Firestore/local merged
        updateView();
    }catch(err){
        console.error('register error', err);
        showNotification(err.message || 'خطأ في إنشاء الحساب','error');
    }
}, true);

// Login form
safeAddListener('login-form','submit', async (e) => {
    e.preventDefault();
    const email = (document.getElementById('login-email').value||'').trim();
    const password = document.getElementById('login-password').value||'';
    try{
        await signInWithEmailAndPassword(auth, email, password);
        showNotification('تم تسجيل الدخول','success');
        // onAuthStateChanged will handle rest
    }catch(err){ console.error('login error', err); showNotification(err.message || 'خطأ في تسجيل الدخول','error'); }
}, true);

// Admin login form (still permit local check for admin credentials, but we also sign in)
safeAddListener('admin-login-form','submit', async (e) => {
    e.preventDefault();
    const email = (document.getElementById('admin-email').value||'').trim();
    const password = document.getElementById('admin-password').value||'';
    try{
        // try firebase sign-in first
        await signInWithEmailAndPassword(auth, email, password);
        // additionally mark admin if email matches
        state.isAdmin = (email === 'admin@gmail.com');
        showNotification('تم تسجيل دخول المسؤول','success');
    }catch(err){
        console.error('admin login error', err);
        // fallback to legacy admin credentials
        if(email==='admin@gmail.com' && password==='admin123'){
            // sign in anonymously in firebase? just set state and create stub user
            state.currentUser = email;
            state.isAdmin = true;
            await setDoc(doc(db,'users',cartDocId(email)), { email, name: 'admin', admin: true, createdAt: serverTimestamp() });
            showNotification('تم تسجيل دخول المسؤول (محلي)','success');
            loadUserData();
            updateView();
        } else {
            showNotification('بيانات المسؤول غير صحيحة','error');
        }
    }
}, true);

// Logout buttons
safeAddListener('logout-btn','click', async (e)=>{ e.preventDefault(); try{ await signOut(auth); state.currentUser=null; state.isAdmin=false; localStorage.removeItem('cart'); showNotification('تم تسجيل الخروج','success'); updateView(); }catch(err){ console.error(err); showNotification('خطأ أثناء تسجيل الخروج','error'); } }, true);
safeAddListener('logout-btn-mobile','click', async (e)=>{ e.preventDefault(); try{ await signOut(auth); state.currentUser=null; state.isAdmin=false; localStorage.removeItem('cart'); showNotification('تم تسجيل الخروج','success'); updateView(); toggleMobileMenu(); }catch(err){ console.error(err); showNotification('خطأ أثناء تسجيل الخروج','error'); } }, true);

// Listen to auth state changes
onAuthStateChanged(auth, async (user) => {
    if(user){
        state.currentUser = user.email;
        // if admin email
        state.isAdmin = (user.email === 'admin@gmail.com');
        // load user data and merge guest cart
        await loadProductsFromLocalStorage();
        await mergeGuestCartIntoFirestore();
        await loadCartFromFirestore();
        updateView();
    } else {
        // signed out
        state.currentUser = null;
        state.isAdmin = false;
        // load guest cart from localStorage
        loadCartFromLocalStorage();
        updateView();
    }
});

// Hook product add/save cart operations to persist to Firestore when user is logged in
// Monkey-patch saveCartToLocalStorage to call Firestore save as well
const originalSaveCart = window.saveCartToLocalStorage || function(){};
window.saveCartToLocalStorage = async function(){
    try{ originalSaveCart(); }catch(e){ /* ignore */ }
    if(state.currentUser){
        await saveCartToFirestore();
    } else {
        // guest cart saved locally already by original function
    }
};

// On page unload, ensure cart saved
window.addEventListener('beforeunload', async ()=>{
    try{ if(state.currentUser) await saveCartToFirestore(); else saveCartToLocalStorage(); }catch(e){}
});

</script>

</body>

</html>
